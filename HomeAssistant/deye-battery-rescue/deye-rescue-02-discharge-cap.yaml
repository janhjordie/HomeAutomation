alias: "Deye-Rescue-02 v1.0.6: SOC-Based Discharge Limiter (Authority Mode)"
description: "ğŸ”’ AUTHORITATIVE: EXPONENTIAL curve from 15-50% SOC. More protection at low SOC, more power at high SOC. v1.0.6: Exponential + lowered floor to 15% SOC. Enforces every 15 seconds."

triggers:
  # âš¡ HIGHEST PRIORITY: React IMMEDIATELY when discharge changes (any value)
  - trigger: state
    entity_id: number.solarcust0186_maximum_battery_discharge_current
  
  # React to SOC changes
  - trigger: state
    entity_id: sensor.solarcust0186_battery_charge_level
      
  # Home Assistant startup
  - trigger: homeassistant
    event: start
    
  # ğŸ”„ AGGRESSIVE periodic check: every 15 seconds (fast response)
  - trigger: time_pattern
    seconds: "/15"
    
conditions: []

actions:
  # Calculate SOC-based limit FIRST (always required)
  - variables:
      # Current sensor values
      soc: "{{ states('sensor.solarcust0186_battery_charge_level') | float(50) }}"
      current_cap: "{{ states('number.solarcust0186_maximum_battery_discharge_current') | float(0) }}"
      
      # SOC-based power curve (AUTHORITATIVE - EXPONENTIAL)
      SOC_MAX: 45           # Above this: max power
      SOC_MIN: 15           # Below this: min power (lowered from 25!)
      POWER_MAX: 2500       # Max power at 50% SOC
      POWER_MIN: 800        # Min power at 15% SOC
      BOOST: 1.05           # 5% boost for stable voltage
      
      # EXPONENTIAL curve: power = MIN + (MAX-MIN) Ã— normalizedÂ²
      # This gives more protection at low SOC, more power at high SOC
      soc_normalized: "{{ ((soc - SOC_MIN) / (SOC_MAX - SOC_MIN)) | float }}"
      soc_power_limit_w: >-
        {% if soc >= SOC_MAX %}
          {{ (POWER_MAX * BOOST) | round(0) }}
        {% elif soc <= SOC_MIN %}
          {{ (POWER_MIN * BOOST) | round(0) }}
        {% else %}
          {% set normalized = (soc - SOC_MIN) / (SOC_MAX - SOC_MIN) %}
          {% set exponential = normalized * normalized %}
          {{ ((POWER_MIN + (POWER_MAX - POWER_MIN) * exponential) * BOOST) | round(0) }}
        {% endif %}
      
      # Convert to amps (at 48V nominal)
      soc_limit_a: "{{ (soc_power_limit_w / 48) | round(0) }}"
      
      # Connection and automation states
      is_connected: "{{ is_state('binary_sensor.solarcust0186_connection_status', 'on') }}"
      is_discharging: "{{ current_cap > 0 }}"
      rescue_active: "{{ is_state('input_boolean.deye_rescue_active', 'on') }}"
      ev_active: "{{ is_state('input_boolean.deye_ev_charging_active', 'on') }}"

  # DEBUG: Show why enforcement happens or skips
  - if:
      - condition: template
        value_template: "{{ (current_cap | round(0) | int) != (soc_limit_a | round(0) | int) }}"
    then:
      - action: persistent_notification.create
        data:
          notification_id: deye_soc_limiter_needed
          title: "âš¡ Deye-02 ENFORCING v1.0.2"
          message: >
            ğŸ“Š SOC: {{ soc | round(1) }}%
            
            ğŸ’¾ Current Discharge: {{ current_cap | round(0) }}A
            ğŸ¯ SOC Curve Limit: {{ soc_limit_a | round(0) }}A ({{ soc_power_limit_w | round(0) }}W)
            
            ğŸ”’ ENFORCING: {{ current_cap | round(0) }}A â†’ {{ soc_limit_a | round(0) }}A
            
            Status:
            â€¢ Connection: {{ 'âœ“ ON' if is_connected else 'âœ— OFF' }}
            â€¢ Discharging: {{ 'âœ“ YES' if is_discharging else 'âœ— NO' }}
            â€¢ Rescue Active: {{ rescue_active }}
            â€¢ EV Charging: {{ ev_active }}
    else:
      - action: persistent_notification.create
        data:
          notification_id: deye_soc_limiter_ok
          title: "âœ… Deye-02 OK v1.0.2"
          message: >
            ğŸ“Š SOC: {{ soc | round(1) }}%
            âœ“ Already at limit: {{ current_cap | round(0) }}A = {{ soc_limit_a | round(0) }}A ({{ soc_power_limit_w | round(0) }}W)

  # ğŸš¨ ENFORCEMENT: Always enforce SOC limit if different (NO CONDITIONS!)
  - if:
      - condition: template
        value_template: "{{ is_connected and is_discharging and (current_cap | round(0) | int) != (soc_limit_a | round(0) | int) }}"
    then:
      - action: number.set_value
        target:
          entity_id: number.solarcust0186_maximum_battery_discharge_current
        data:
          value: "{{ soc_limit_a }}"
      
      - delay: "00:00:01"
      
      - action: persistent_notification.create
        data:
          notification_id: deye_soc_limiter_confirmed
          title: "âœ… Deye-02 ENFORCED v1.0.2"
          message: >
            â° {{ now().strftime('%H:%M:%S') }}
            
            Set: {{ current_cap | round(0) }}A â†’ {{ soc_limit_a | round(0) }}A
            
            ğŸ“Š SOC: {{ soc | round(1) }}%
            ğŸ“ˆ Power Limit: {{ soc_power_limit_w | round(0) }}W @ 48V
            
            âœ“ SOC Curve is NOW the authoritative source

mode: queued
max: 10
