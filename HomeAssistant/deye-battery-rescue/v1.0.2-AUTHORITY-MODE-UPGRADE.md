# Deye-02 v1.0.2: Authority Mode Upgrade

## The Problem (v1.0.1)
At 19% SOC, the battery could briefly discharge at 90A before Deye-02 enforced the SOC curve:
1. Rescue ends → Deye-01 sets discharge to 90A (seasonal winter limit)
2. Deye-02 checks every **1 minute** (or on state change)
3. **Gap:** If high load starts in those 30-60 seconds, discharge attempts 90A at critical SOC

**Why this matters:** At 19% SOC, discharge should be ~12A max (600W), not 90A (4320W!)

## The Solution (v1.0.2)

### 1. **Deye-02 is NOW the Authoritative Source**
- **Discharge ALWAYS follows SOC curve** — no exceptions, no negotiations
- SOC curve is Priority 0 (overrides everything including rescue/EV flags)
- No state checks: runs even when rescue is active

### 2. **More Aggressive Enforcement**
```yaml
# Before (v1.0.1):
- trigger: time_pattern
  minutes: "/1"  # Check every 1 minute

# After (v1.0.2):
- trigger: time_pattern
  seconds: "/30"  # Check every 30 seconds
```

### 3. **Deye-01 Cleanup Already Smart (was already correct)**
Deye-01's rescue cleanup already calculates SOC-based limit:
```yaml
restore_discharge_a: "{{ [discharge_a_normal | float, soc_limit_a | float] | min }}"
# Uses: min(seasonal_limit, soc_curve_limit)
# Example at 19% SOC: min(60A, 12A) = 12A ✓
```

**Flow:**
1. Deye-01 calculates: SOC=19% → limit=12A
2. Deye-01 sets discharge to 12A
3. Deye-02 immediately triggers on discharge state change
4. **Deye-02 verifies and enforces: 12A stays 12A** (or corrects if SolarBalance wrote something else)
5. Every 30 seconds: Deye-02 checks again (catches SolarBalance drift)

## Key Changes in Code

### Variables Section
```yaml
# Simplified - now calculates in actions, not top-level variables
# Removed: base_cap, is_winter, complex power calculations
```

### Actions (Simplified & Powerful)
```yaml
# Old logic: Had conditions that could skip enforcement
# New logic: Always calculates, always enforces

- if: discharge_current_differs_from_soc_limit
  then: SET discharge to soc_limit (no conditions!)
```

## Behavior Examples

### Example 1: Battery at 19% SOC, Rescue Ends
```
Timeline:
t=0:00   Rescue active, discharge=10A
t=1:23   Voltage recovered, Deye-01 cleanup runs
         - Calculates: SOC=19% → limit=12A
         - Sets discharge=12A
         - Turns off rescue_active flag

t=1:24   Deye-02 triggers immediately (discharge state changed)
         - Verifies: 12A is correct for 19% SOC ✓
         - No change needed

t=2:54   Deye-02 periodic check (every 30 sec)
         - Verifies: 12A still correct ✓

Result: ✅ Discharge NEVER exceeds 12A @ 19% SOC
```

### Example 2: SolarBalance Writes Wrong Value
```
Timeline:
t=10:00  Normal discharge: 52A @ 50% SOC (correct)
t=10:15  SolarBalance update changes discharge to 90A (!)
t=10:15  Deye-02 triggers on discharge state change
         - Calculates: SOC=50% → limit=52A
         - Current: 90A (wrong!)
         - Sets discharge=52A ✓

t=10:45  Deye-02 periodic check
         - Verifies: 52A still correct ✓

Result: ✅ SolarBalance drift caught and corrected within seconds
```

## Version History

### v1.0.2 (Current)
- **AUTHORITY MODE**: SOC curve is always the floor
- Increased check frequency: every 30 seconds (was 1 minute)
- Simplified logic: no blocking flags in enforcement
- Deye-01 cleanup already respects SOC limits

### v1.0.1
- Basic SOC-based limiting
- Checked every 1 minute (too slow for critical low SOC)
- Could be blocked by rescue/EV flags

## Testing the Change

### Manual Test at 19% SOC
1. Trigger Deye-01 rescue manually (use Developer Tools → Select Deye-01 → Test Trigger)
2. Wait for rescue to complete (voltage recovery)
3. Watch Home Assistant notifications during cleanup
4. Expected: Discharge value = ~12A (not 90A)
5. Check CSV log: `max_discharge_a` column should show 12

### Test SolarBalance Interference
1. Wait until normal operation (~50% SOC)
2. Manually set discharge to 90A via Home Assistant UI
3. Wait <30 seconds
4. Deye-02 should correct it to ~52A (SOC limit @ 50%)

## CSV Log Fields (for monitoring)

Key columns in `deye_weekly_log.csv`:
- `soc`: Battery state of charge
- `max_discharge_a`: Current discharge limit (what you'll see Deye-02 enforce)
- `soc_limit_a`: Calculated SOC curve limit
- `rescue_active`: Whether rescue is running
- `seasonal_discharge_a`: Base seasonal limit (60A winter, 90A summer)

**Expected behavior:**
- At 19% SOC: `max_discharge_a` should match `soc_limit_a` (~12A)
- At 50% SOC: `max_discharge_a` should match `soc_limit_a` (~52A)
- If they differ: Deye-02 is correcting SolarBalance interference
