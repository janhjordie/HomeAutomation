# v1.0.44: Voltage Threshold Adjustment (Collapse Prevention)

**Date:** 2026-02-19  
**Incident:** Battery voltage collapsed from 49.8V → 46.3V in 63 minutes (Feb 18-19, 08:35-09:38)  
**Root Cause:** Overly aggressive voltage override thresholds in deye-01-discharge-curve.yaml

---

## Problem Analysis

### Collapse Sequence
| Time | SOC | Voltage | Max Discharge | Load | Issue |
|------|-----|---------|---------------|------|-------|
| 08:44 | 34% | 48.49V | **20A** (960W) | 2.5kW | Load deficit! |
| 08:49 | 33% | 48.07V | **10A** (480W) | 2.5kW | Cascading failure |
| 09:38 | 31% | 46.3V  | **1A** (48W)  | 2.7kW | Battery offline |

### Root Cause: Death Spiral
The **discrete voltage override thresholds created a feedback loop:**

1. **Voltage starts drifting down** (normal, ~-2.7V/min due to load)
2. **At 48.49V:** System cuts discharge from 33A → **20A** (threshold < 48.5V)
3. **Load = 2.5kW, available = 960W:** Voltage collapses even faster (~-3V/min)
4. **At 48.07V:** System cut again to **10A** (threshold < 48.0V)
5. **Faster collapse triggers more cuts:** 10A → 5A → 1A → **CRITICAL_EMERGENCY**

---

## Changes Made

### 1. Deye-01 Voltage Override Thresholds (CRITICAL)

**File:** `/HomeAssistant/deye-battery-rescue/deye-01-discharge-curve.yaml` (lines 73-81)

#### OLD (Aggressive)
```yaml
volt_limit_a: |-
  {% if batt_v < 47.0 %} 1
  {% elif batt_v < 47.5 %} 5
  {% elif batt_v < 48.0 %} 10
  {% elif batt_v < 48.5 %} 20        ← TOO RESTRICTIVE
  {% elif batt_v < 49.0 %} 35
  {% else %} {{ DISCHARGE_MAX_A }}
```

#### NEW (Smoothed, Gradual Reductions)
```yaml
volt_limit_a: |-
  {% if batt_v < 47.0 %} 1
  {% elif batt_v < 47.2 %} 3
  {% elif batt_v < 47.5 %} 8
  {% elif batt_v < 48.0 %} 15        ← 50% increase from 10A
  {% elif batt_v < 48.5 %} 30        ← 50% increase from 20A
  {% elif batt_v < 49.0 %} 50        ← 43% increase from 35A
  {% else %} {{ DISCHARGE_MAX_A }}
```

**Key Improvements:**
- **48.5V threshold:** 20A → 30A (+50%) — allows voltage to stabilize naturally
- **48.0V threshold:** 10A → 15A (+50%) — prevents cascade at mid-range
- **49.0V threshold:** 35A → 50A (+43%) — maintains discharge when voltage recovers
- **47.5V threshold:** 5A → 8A (+60%) — smoother transition at caution level
- **NEW 47.2V threshold:** Added intermediate step (3A) to provide better granularity

**Result:** System can now maintain 1.4-1.5kW min discharge even below 48.5V, preventing the death spiral.

---

### 2. Voltage Penalty Thresholds (LOGGING)

**File:** `/HomeAssistant/deye-analytics/deye-monitor-01-logging.yaml` (lines 63-72)

#### OLD (Too Aggressive)
```yaml
volt_penalty_threshold: >-
  {% if volt < 49.5 %}      15A penalty  ← Applied at normal operating voltage!
  {% elif volt < 50.0 %}    10A
  {% elif volt < 50.5 and soc < soc_max %} 5A
  {% else %} 0
```

#### NEW (Only for Emergency)
```yaml
volt_penalty_threshold: >-
  {% if volt < 48.0 %}      15A penalty  ← Only below CAUTION threshold
  {% elif volt < 48.5 %}    10A
  {% elif volt < 49.0 %}    5A
  {% else %} 0
```

**Key Improvements:**
- **Penalty never applies above 48.0V** — no penalties during normal/caution operation
- **Penalties only for CRITICAL_LOW and below** — reserved for true emergencies
- **Result:** 15A penalty now only triggers at 47.9V (was 49.5V) — much safer threshold

---

## Impact on Battery Behavior

### Before (Problematic)
```
Normal operation 50.0V
  ↓ (load causes natural drift)
Threshold: 49.5V → Penalty: 15A  ← Too early!
  ↓ (restricted discharge, voltage sags faster)
Threshold: 48.5V → Cut to 20A    ← Death spiral starts
  ↓ (load unmet, voltage collapse accelerates)
Threshold: 48.0V → Cut to 10A
  ↓ (free fall)
Threshold: 47.0V → CRITICAL_EMERGENCY at 46.3V
```

### After (Protected)
```
Normal operation 50.0V
  ↓ (load causes natural drift)
Threshold: 49.0V → No penalty, allow 50A  ← Natural stabilization zone
  ↓ (discharge meets load, voltage stabilizes)
Threshold: 48.5V → Gentle cut to 30A      ← Can still supply 1.4kW
  ↓ (maintains load, prevents fast collapse)
Threshold: 48.0V → Only NOW apply penalty ← SAFE threshold
  ↓ (controlled descent if further issues)
Recovery possible above 48.5V (natural threshold hysteresis)
```

---

## Expected Outcomes

✅ **Voltage stabilization:** Should prevent cascading cuts below 48.5V  
✅ **Load continuity:** Can now maintain ~1.4kW+ discharge down to 48.0V  
✅ **Graceful degradation:** Smooth curves instead of aggressive jumps  
✅ **Natural recovery:** If voltage rises back to 48.6V, system re-enables normal discharge  

⚠️ **Still protected:** Emergency thresholds remain at <48.0V for true critical situations

---

## Testing Notes

Monitor these thresholds in CSV logs after redeployment:
- `max_discharge_a` should stay ≥25A down to 48.5V
- `volt_penalty_a` should remain 0 above 48.0V
- Voltage should stabilize naturally without oscillations
- No CRITICAL_EMERGENCY state unless voltage truly < 47.2V

---

## Version Info
- **Automation:** Deye-01 v1.0.44 (was v1.0.43)
- **Logging:** Updated penalty thresholds (no version change)
- **Archive:** Old v1.0.43 parameters saved in archive/

