alias: "Deye-Rescue-05 v1.0.4: Low SOC Charge Guard"
description: "Protects battery during recovery by capping charge current to 5A when grid charging OR SOC < 15%. v1.0.4: Lowered SOC threshold from 20% to 15% to match Deye-02 curve."

triggers:
  # React when SOC changes
  - trigger: state
    entity_id: sensor.solarcust0186_battery_charge_level
  
  # React when charge current changes
  - trigger: state
    entity_id: number.solarcust0186_maximum_battery_charge_current
  
  # React when grid charge is enabled
  - trigger: state
    entity_id: switch.solarcust0186_grid_charge
    
  # Home Assistant startup
  - trigger: homeassistant
    event: start
    
  # Periodic check every 15 seconds (fast response)
  - trigger: time_pattern
    seconds: "/15"

conditions:
  - condition: state
    entity_id: binary_sensor.solarcust0186_connection_status
    state: "on"

actions:
  - variables:
      soc: "{{ states('sensor.solarcust0186_battery_charge_level') | float(100) }}"
      current_charge_a: "{{ states('number.solarcust0186_maximum_battery_charge_current') | float(0) }}"
      # FIXED: Use direct is_state() in max_charge_a to avoid string/boolean bug
      max_charge_a: "{{ 5 if ((soc | float) < 15 or is_state('switch.solarcust0186_grid_charge','on')) else 60 }}"

  # Step 1: Show trigger notification
  - action: persistent_notification.create
    data:
      notification_id: deye_lowsoc_charge_trigger
      title: "ğŸ”µ Deye-05 Triggered v1.0.4"
      message: >-
        â° {{ now().strftime('%H:%M:%S') }}
        
        ğŸ“Š SOC: {{ soc | round(1) }}%
        âš¡ Current Charge: {{ current_charge_a | round(0) }}A
        ğŸ”Œ Grid Charge: {{ states('switch.solarcust0186_grid_charge') }}
        
        ğŸš¨ Critical: {{ 'YES' if ((soc | float) < 15 or is_state('switch.solarcust0186_grid_charge','on')) else 'NO' }}
        ğŸ“ˆ Max Allowed: {{ max_charge_a }}A
        
        âœ… Will enforce: {{ (current_charge_a | round(0) | int) != (max_charge_a | int) }}

  # Step 2: Enforce limit if different from current
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ (current_charge_a | round(0) | int) != (max_charge_a | int) }}"
        sequence:
          - alias: Set charge current to limit
            action: number.set_value
            target:
              entity_id: number.solarcust0186_maximum_battery_charge_current
            data:
              value: "{{ max_charge_a }}"
          
          - alias: Confirm enforcement
            action: persistent_notification.create
            data:
              notification_id: deye_lowsoc_charge_enforced
              title: "âœ… Deye-05 Enforced v1.0.4"
              message: >-
                â° {{ now().strftime('%H:%M:%S') }}
                
                âš¡ Changed: {{ current_charge_a | round(0) }}A â†’ {{ max_charge_a }}A
                
                ğŸ“Š SOC: {{ soc | round(1) }}%
                ğŸ”Œ Grid Charge: {{ states('switch.solarcust0186_grid_charge') }}

    default:
      - alias: No change needed
        action: persistent_notification.create
        data:
          notification_id: deye_lowsoc_charge_skip
          title: "â­ï¸ Deye-05 OK v1.0.4"
          message: >-
            Already at {{ current_charge_a | round(0) }}A (limit: {{ max_charge_a }}A)

mode: queued
max: 10
