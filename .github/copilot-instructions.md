# Home Automation Copilot Instructions

## System Architecture Overview

This repository manages a **Home Automation system** with two main components:

### 1. **Deye Battery Protection System** (Home Assistant)
- **Purpose:** Prevent battery deep-discharge and voltage collapse on a Deye/SolarMax hybrid inverter
- **Critical Period:** 17:00-23:00 (high electricity prices + peak loads)
- **Data Flow:** Real-time sensor inputs â†’ 3-tier automation priority â†’ Inverter control

### 2. **Heat Pump Integration** (Homey â†’ Home Assistant)
- **Purpose:** Adaptive heat pump flow temperature based on outdoor conditions and MELCloud data
- **Communication:** Homey scripts POST JSON to Home Assistant webhooks
- **Data Pipeline:** Ecodan curves â†’ Homey logic â†’ HA webhook â†’ CSV logging

---

## Priority Automation Hierarchy

**All three automations run independently but with strict priority ordering:**

| Priority | Automation | File | Trigger | Action |
|----------|-----------|------|---------|--------|
| **1** | EV Charge Guard (Deye-03) | `deye-rescue-03-ev-guard.yaml` | EV webhook, discharge changes | Force discharge=0A when EV charging |
| **2** | Panic/Voltage Rescue (Deye-01) | `deye-rescue-01-panic.yaml` | 7 voltage triggers + SOC conditions | Grid charge + limit discharge to 10A |
| **3** | SOC Limit Enforcement (Deye-04) | `deye-rescue-04-counter-reset.yaml` | Discharge current, voltage, SOC changes | Calculate power limits from SOC curve |

**Critical Ordering Rule:** Rescue cleanup sequence in Deye-01:
1. Turn OFF `input_boolean.deye_rescue_active` FIRST (unblock Deye-04)
2. Restore discharge to 60A (winter) or 90A (summer)
3. Triggers Deye-04 to re-enforce SOC limits

---

## Deye Automation Configuration

### Voltage Thresholds (centralized in `deye-config.yaml`)
```yaml
47.2V  # Emergency guard (idle, no load required)
47.8V  # Panic mode (instant)
48.0V  # Hard rescue (5s delay)
49.2-49.6V  # Preemptive (with load/discharge conditions)
50.2V  # Stop charging (rescue complete)
```

### Current Limits
- **Rescue charge:** 5-10A (vs normal 60-90A discharge)
- **Grid charge:** Turn ON to charge inverter during rescue
- **Safe discharge:** 10A max during rescue

### Helper Entities Required
All defined in `deye-infra/deye-helpers.md`:
- `input_boolean.deye_rescue_active` â€” Rescue flag (blocks Deye-04)
- `input_boolean.deye_ev_charging_active` â€” EV flag (blocks Deye-04)
- `input_number.deye_rescue_count_6h` â€” Rescue frequency tracking
- `input_number.deye_trig_volt_soft_learned` â€” Adaptive voltage threshold (learned from patterns)

---

## Developer Workflows

### Home Assistant Automations
1. **Edit:** Use HA UI (Settings â†’ Automations) or YAML files directly
2. **ðŸš¨ CRITICAL: UPDATE VERSION NUMBER** â€” ALWAYS increment PATCH version in `alias:` on EVERY change
   - Format: `"Deye-Rescue-XX v1.0.Z: Description"` (increment Z only: 1.0.0 â†’ 1.0.1 â†’ 1.0.2)
   - Increment patch in notification titles too if they contain version numbers
   - NO EXCEPTIONS - even for minor fixes
   - This is for internal use only
3. **Validate YAML:** Always run a YAML checker before deploying
   - Use online validators: https://www.yamllint.com/
   - Or locally: `python3 -c "import yaml; yaml.safe_load(open('file.yaml'))"`
   - **CRITICAL:** Check indentation â€” Home Assistant is very strict on spacing
4. **Test:** Use HA Developer Tools â†’ Automation â†’ Trigger (simulate triggers)
5. **Debug:** Check Trace tab in automation detail view for action sequence
6. **Deploy:** YAML files auto-reload; UI changes need "Reload Automations"

### Homey Scripts (JavaScript)
- Location: `/Homey/HA_Integration.js`, `SendEVWebhook.js`
- **Deployment:** Edit in Homey mobile app â†’ Flow â†’ Script
- **Testing:** Use Homey logs (Homey Pro â†’ Settings â†’ Debugging) 
- **HA Webhook Format:** Must match `webhook_id` in Home Assistant automation

### CSV Logging
- **Location:** `HomeAssistant/ecodan/` (generated by webhook handler)
- **Rotation:** Yearly (summer) by `deye-analytics-02-season-notify.yaml`

---

## Key Patterns & Conventions

### 1. Jinja2 Templates in Triggers
```yaml
# Multi-condition triggers use template syntax with float safety
value_template: |
  {{ (states('sensor.solarcust0186_battery_voltage') | float(999)) < 49.2
     and (states('sensor.solarcust0186_load_totalpower') | float(0)) > 2400 }}
for: "00:00:20"  # Additional delay before trigger fires
```

### 2. Mode Queuing for Concurrent Triggers
```yaml
mode: queued
max: 10  # Handle up to 10 concurrent rescue events
```
This prevents lost events when multiple triggers fire simultaneously (e.g., voltage + SOC).

### 3. State Variable Pattern in Actions
```yaml
- variables:
    is_winter: "{{ (now().month) in [10,11,12,1,2,3] }}"
    DISCHARGE_A: "{{ 60 if is_winter else 90 }}"
    ev_active: "{{ is_state('input_boolean.deye_ev_charging_active','on') }}"
```
Calculated once in variables section, referenced in conditions & choose blocks.

### 4. Choose/When Structure for Multi-Branch Logic
```yaml
- choose:
    - conditions: [...]  # IF
      sequence: [...]    # THEN
    - conditions: [...]  # ELSE IF
      sequence: [...]    # THEN
  default: [...]         # ELSE
```

### 5. Safe State Defaults
Always use `| float(0)` or `| float(999)` filters:
- `float(0)` for power/current (missing = 0W)
- `float(999)` for voltage (missing = treated as very high, won't trigger low-volt rescue)

---

## Cross-Component Communication

### HA â†’ Deye Inverter
- **Protocol:** Modbus TCP (via SolarCustom integration)
- **Update Cycle:** Our automations override SolarBalance settings every 30s
- **Write Entities:**
  - `number.solarcust0186_maximum_battery_discharge_current` (0-100A)
  - `switch.solarcust0186_grid_charge` (on/off)
  - `number.solarcust0186_maximum_battery_charge_current` (0-20A)

### Homey â†’ HA Webhooks
- **EV Charging:** `webhook_id: deye_ev_start_easee` (Start/Stop)
- **MELCloud Heat Pump:** `webhook_id: melcloud_homey` (Periodic temperature data)
- **Response:** HA automation processes webhook payload â†’ updates helpers

### HA â†’ Homey (Device Control)
- Not implemented; one-way communication only
- Could add reverse webhook in future for grid_charge feedback

---

## Common Maintenance Tasks

### Adding a New Rescue Trigger
1. Add new trigger with unique `id:` in Deye-01
2. Add corresponding voltage/load thresholds to `deye-config.yaml`
3. Document in [SYSTEM-DIAGRAM.md](HomeAssistant/SYSTEM-DIAGRAM.md)
4. Test: Use Developer Tools â†’ Trigger simulation

### Adjusting SOC Curve
1. Edit Deye-04 action variables (search `POWER_MAX`, `POWER_MIN`)
2. Formula: `power = POWER_MAX - (50 - SOC) * 80` (80W per 1% SOC)
3. Test: Trigger at target SOC, check `sensor.solarcust0186_battery_charge_level`

### Seasonal Current Limits
- Update `DISCHARGE_NORMAL_WINTER` (60A Oct-Mar) in Deye-03
- Update `DISCHARGE_NORMAL_SUMMER` (90A Apr-Sep) in Deye-03
- Changes take effect next rescue trigger

---

## Debugging Checklist

### Rescue Not Triggering
- [ ] Check helper entity exists: `input_boolean.deye_rescue_active`
- [ ] Verify sensor available: `sensor.solarcust0186_battery_voltage`
- [ ] Test trigger manually: Developer Tools â†’ Automations â†’ Test
- [ ] Check Trace tab for condition failures

### Discharge Not Changing
- [ ] Check entity writable: `number.solarcust0186_maximum_battery_discharge_current`
- [ ] Verify connection: `binary_sensor.solarcust0186_connection_status` = on
- [ ] Check mode: Deye-04 has conditions blocking if rescue_active=on

### EV Charge Not Activating
- [ ] Verify Homey flow posts to correct webhook: `deye_ev_start_easee`
- [ ] Check Home Assistant webhook is enabled: Settings â†’ Automations & Scenes â†’ Webhooks
- [ ] Test manually: `curl -X POST http://homeassistant.local:8123/api/webhook/deye_ev_start_easee`

---

## References
- [SYSTEM-DIAGRAM.md](HomeAssistant/SYSTEM-DIAGRAM.md) â€” Visual automation priority & voltage curves
- [SYSTEM-GOALS.md](HomeAssistant/SYSTEM-GOALS.md) â€” Operational objectives & future enhancements
- [MIGRATION-GUIDE.md](MIGRATION-GUIDE.md) â€” v2.0 consolidation details
- [deye-config.yaml](HomeAssistant/deye-infra/deye-config.yaml) â€” Centralized constants (reference only)
